# Headscale SSH 隧道连接工具 (v3.1)

本项目提供一个名为 `hs-connect` 的命令行工具，用于在无法直接进行 TLS 连接到 Headscale 服务器的情况下，通过建立 SSH 隧道来安全地注册和连接 Tailscale 节点。

与普通脚本不同，本项目注重**易用性**、**健壮性**和**安全性**，内置了完整的交互式配置向导、环境检查和进程管理机制。

## 核心原理

在某些网络环境中，服务提供商可能会对出站的 TLS 连接进行深度包检测（DPI）或特征审查，这可能导致标准的 Headscale 连接被中断或失败。

为了绕过这种审查，本工具采用了一种 SSH 隧道技术：

1.  **建立隧道**：通过 SSH 在本地机器和您的 Headscale 服务器之间建立一个安全的隧道。
2.  **端口转发**：它将本机的 `443` 端口转发到 Headscale 服务器上的 `localhost:443`。这意味着，当 Tailscale 客户端尝试连接 `https://<你的域名>` 时，由于 `/etc/hosts` 文件的配置，流量实际上被导向到 `127.0.0.1:443`，也就是 SSH 隧道的入口。
3.  **安全通信**：流量通过 SSH 隧道安全地传输到您的服务器，然后在服务器内部直接访问 Headscale 服务。由于流量被封装在 SSH 协议内，外部网络无法审查其内部的 TLS 握手过程，从而成功规避了连接问题。

整个过程可以简化为：
`Tailscale 客户端 -> 本地 443 端口 -> SSH 隧道 -> Headscale 服务器 -> Headscale 服务`

## 特性

- **交互式配置**：首次运行时自动引导用户完成所有必要配置，无需手动编辑文件。
- **智能的环境检查**：启动前自动检查 `tailscale`, `ssh`, `nc`, `lsof` 等核心依赖，并验证 `/etc/hosts` 文件配置。
- **极其健壮的进程管理**：
    - **杜绝僵尸进程**：在启动前和结束后，使用 `lsof` 强制查找并清理任何残留的隧道进程，彻底解决了因断网、异常退出导致的端口占用问题。
    - **精确的 PID 识别**：通过查询 `/proc` 文件系统来识别由 `lsof` 找到的进程，避免了 `ps` 命令在不同系统间的兼容性问题。
- **可靠的 `sudo` 环境执行**：能够智能地以原始用户身份检查 SSH Agent，确保在 `sudo` 环境下认证过程的正确性。
- **清晰的错误处理**：在 SSH 密钥认证失败时会立即报错退出，而不是挂起等待密码输入，让问题定位更简单。
- **优雅的退出机制**：通过 `trap` 捕获中断信号，确保任何情况下都能清理残留进程。
- **状态检查**：提供 `status` 命令，快速了解隧道和节点的当前状态。

## 安装

1.  **克隆或下载项目**
    首先，获取项目文件。
    ```bash
    git clone https://github.com/w31r4/headscale-ssh-tunnel.git
    cd headscale-ssh-tunnel
    ```

2.  **为脚本添加可执行权限**
    在运行安装脚本之前，您需要先为其添加可执行权限：
    ```bash
    chmod +x install.sh
    ```

3.  **运行安装脚本**
    使用 `sudo` 权限运行安装脚本。该脚本会将 `hs-connect` 命令安装到 `/usr/local/bin`，并设置必要的权限。
    ```bash
    sudo ./install.sh
    ```

## 用法

安装完成后，您可以在任何地方直接使用 `hs-connect` 命令。

如果这是您第一次运行，工具会启动一个交互式的设置向导，引导您完成配置。

### 启动隧道并激活节点
```bash
hs-connect start
```

### 关闭隧道
```bash
hs-connect stop
```

### 检查连接状态
```bash
hs-connect status
```

## 卸载

如果您希望从系统中移除本工具，请在项目目录中运行卸载脚本：
```bash
sudo ./uninstall.sh
```

## 前提条件

在运行工具前，请确保您已完成以下配置。工具会自动检查这些条件，并在不满足时给出提示。

1.  **修改 Hosts 文件**：
    在您的 **本地客户端机器** 上，编辑 `/etc/hosts` 文件 (需要 `sudo` 权限)，添加以下行：
    ```
    127.0.0.1 your.headscale.domain.com
    ```
    *(工具会自动检查该配置是否存在)*

2.  **配置 SSH 免密登录**：
    确保您可以从本地机器通过 SSH 密钥免密码登录到您的 Headscale 服务器。

3.  **SSH Agent 配置**：
    工具会检查您的 SSH Agent 中是否已加载私钥。在运行前，请确保执行了以下命令来加载密钥：
    ```bash
    eval $(ssh-agent -s)
    ssh-add /path/to/your/private_key
    ```

## 故障排查

- **错误：/etc/hosts 文件缺少必要的条目。**
  -> 请按照“前提条件”中的说明，编辑 `/etc/hosts` 文件。

- **错误：缺少核心依赖 'xxx'。**
  -> 请根据提示安装缺失的命令行工具。例如，在 Debian/Ubuntu 上：`sudo apt-get install openssh-client netcat-openbsd`。

- **错误：未能从服务器获取有效的预授权密钥 (或 Permission denied)。**
  -> 这个错误通常意味着 SSH 密钥认证失败。请检查：
    1.  您的 SSH 免密登录是否配置正确且仍然有效。可以通过 `ssh -i <您的密钥路径> <用户名>@<服务器IP>` 手动测试。
    2.  确保运行脚本前，您的 SSH 密钥已通过 `ssh-add` 添加到 SSH Agent 中。
    3.  您在交互式配置中输入的服务器 IP、SSH 用户名和 Headscale 用户名是否正确。
    4.  服务器上的 Headscale 服务是否正在正常运行。

- **错误：SSH 隧道在 10 秒内未能成功监听端口 443。**
  -> 请检查：
    1.  本地的 `443` 端口是否已被其他程序占用 (`sudo lsof -i:443`)。
    2.  服务器的防火墙是否允许 SSH 连接。